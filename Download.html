<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pin Brawl - –°–∫–∞—á–∞—Ç—å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .container {
            width: 100%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 20px;
        }

        .logo {
            width: 120px;
            height: 120px;
            border-radius: 24px;
        }

        .app-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 2px;
        }

        .app-subtitle {
            font-size: 14px;
            color: #888;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .platform-note {
            font-size: 12px;
            color: #888;
        }

        .username {
            font-size: 17px;
            font-weight: 600;
            padding: 10px 18px;
            border-radius: 12px;
            background: var(--secondary-bg);
            margin: 12px 0;
        }

        .description {
            font-size: 15px;
            line-height: 1.4;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .status-badge {
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin: 10px 0;
        }

        .status-registered {
            background-color: #10B981;
            color: white;
        }

        .status-not-registered {
            background-color: #EF4444;
            color: white;
        }

        .button {
            background: var(--button-color);
            color: white;
            border: none;
            width: 200px;
            height: 54px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s;
            border-radius: 14px;
            margin-top: 12px;
        }

        .button:active {
            transform: scale(0.95);
        }

        .button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .download-info {
            background: var(--secondary-bg);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .download-info h3 {
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .download-info ul {
            text-align: left;
            padding-left: 20px;
            margin-top: 10px;
        }

        .download-info li {
            margin-bottom: 5px;
        }

        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            animation: spin 1.5s linear infinite;
        }

        .loading-text {
            font-size: 15px;
            opacity: 0.8;
        }

        .error {
            color: #ef4444;
            font-size: 14px;
            padding: 10px 12px;
            border-radius: 8px;
            background: rgba(239, 68, 68, 0.1);
            display: none;
            margin-top: 12px;
        }

        .support-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--separator-color);
            width: 100%;
        }

        .support-text {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 12px;
        }

        .support-button {
            background: var(--secondary-bg);
            color: var(--text-color);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .support-button:active {
            opacity: 0.7;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Telegram theme variables */
        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --secondary-bg: #f0f0f0;
            --separator-color: #e5e5e5;
            --button-color: #2481cc;
        }

        .theme-dark {
            --bg-color: #1c1c1c;
            --text-color: #ffffff;
            --secondary-bg: #2d2d2d;
            --separator-color: #3d3d3d;
            --button-color: #3d8ecd;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div id="mainHeader">
            <img src="https://raw.githubusercontent.com/bahrstars/bahrstars.github.io/refs/heads/main/GameFiles/Other/Logo.png" alt="Pin Brawl" class="logo">
            <div class="app-title">Pin Brawl</div>
            <div class="app-subtitle">–ë–µ—Ç–∞-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
            <div class="platform-note">–¢–æ–ª—å–∫–æ –¥–ª—è Android/—ç–º—É–ª—è—Ç–æ—Ä–æ–≤ Android</div>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
        <div id="userInfoView">
            <div class="username" id="usernameDisplay">@username</div>
            <div id="statusBadge" class="status-badge status-not-registered">–ù–ï –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–ù</div>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ -->
        <div class="download-info">
            <h3>üì± –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–≥—Ä—ã</h3>
            <p>–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:</p>
            <ul>
                <li>–°–∫–∞—á–∞–π—Ç–µ APK —Ñ–∞–π–ª</li>
                <li>–†–∞–∑—Ä–µ—à–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</li>
                <li>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</li>
                <li>–í–æ–π–¥–∏—Ç–µ —Å –ø–æ–º–æ—â—å—é Telegram</li>
            </ul>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è -->
        <div id="downloadView">
            <button class="button" id="downloadButton" disabled>–°–ö–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
            <div class="error" id="errorMessage"></div>
        </div>
        
        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div class="loading" id="loadingView">
            <img src="https://raw.githubusercontent.com/bahrstars/bahrstars.github.io/refs/heads/main/GameFiles/Other/Loading.png" alt="Loading" class="loading-spinner">
            <p class="loading-text" id="loadingText">–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é...</p>
        </div>
        
        <!-- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ -->
        <div class="support-section">
            <p class="support-text">–í–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã?</p>
            <a href="https://t.me/PinBrawl?direct" class="support-button">–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞</a>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            databaseURL: "https://project-7947652255084595569-default-rtdb.firebaseio.com/"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // –°—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const DOWNLOAD_URL = "https://getfile.dokpub.com/yandex/get/https://disk.yandex.ru/d/SK-Aeofm-RLQ-g";
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–º—ã Telegram
        function setTelegramTheme() {
            const themeParams = tg.themeParams;
            const isDark = tg.colorScheme === 'dark';
            
            document.body.style.backgroundColor = themeParams.bg_color || (isDark ? '#1c1c1c' : '#ffffff');
            document.body.style.color = themeParams.text_color || (isDark ? '#ffffff' : '#000000');
            
            if (isDark) {
                document.body.classList.add('theme-dark');
            } else {
                document.body.classList.remove('theme-dark');
            }
            
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
            const root = document.documentElement;
            root.style.setProperty('--bg-color', themeParams.bg_color || (isDark ? '#1c1c1c' : '#ffffff'));
            root.style.setProperty('--text-color', themeParams.text_color || (isDark ? '#ffffff' : '#000000'));
            root.style.setProperty('--secondary-bg', themeParams.secondary_bg_color || (isDark ? '#2d2d2d' : '#f0f0f0'));
            root.style.setProperty('--separator-color', themeParams.hint_color || (isDark ? '#3d3d3d' : '#e5e5e5'));
            root.style.setProperty('--button-color', themeParams.button_color || (isDark ? '#3d8ecd' : '#2481cc'));
        }
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const mainHeader = document.getElementById('mainHeader');
        const userInfoView = document.getElementById('userInfoView');
        const downloadView = document.getElementById('downloadView');
        const loadingView = document.getElementById('loadingView');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const statusBadge = document.getElementById('statusBadge');
        const downloadButton = document.getElementById('downloadButton');
        const loadingText = document.getElementById('loadingText');
        const errorMessage = document.getElementById('errorMessage');
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
        const user = tg.initDataUnsafe.user;
        const username = user ? user.username : 'unknown_user';
        const userId = user ? user.id : null;
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        usernameDisplay.textContent = `@${username}`;
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–º—ã
        setTelegramTheme();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
        tg.onEvent('themeChanged', setTelegramTheme);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        checkRegistration();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        downloadButton.addEventListener('click', downloadGame);
        
        // –§—É–Ω–∫—Ü–∏–∏
        async function checkRegistration() {
            showLoading('–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é...');
            
            try {
                const isRegistered = await checkIfRegistered();
                
                if (isRegistered) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
                    statusBadge.textContent = '–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–ù';
                    statusBadge.className = 'status-badge status-registered';
                    downloadButton.disabled = false;
                    downloadButton.textContent = '–°–ö–ê–ß–ê–¢–¨ –ò–ì–†–£';
                } else {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
                    statusBadge.textContent = '–ù–ï –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–ù';
                    statusBadge.className = 'status-badge status-not-registered';
                    downloadButton.disabled = true;
                    downloadButton.textContent = '–°–ö–ê–ß–ê–¢–¨ –ò–ì–†–£';
                    showError('–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–µ—Ç–∞-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                hideLoading();
            }
        }
        
        function checkIfRegistered() {
            return new Promise((resolve, reject) => {
                const userRef = database.ref('preregistrations/' + username);
                
                userRef.once('value')
                    .then(snapshot => {
                        resolve(snapshot.exists());
                    })
                    .catch(error => {
                        reject(error);
                    });
            });
        }
        
        function downloadGame() {
            showLoading('–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ...');
            
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            setTimeout(() => {
                hideLoading();
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
                window.open(DOWNLOAD_URL, '_blank');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                showError('–ï—Å–ª–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞—á–∞–ª–æ—Å—å, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É –µ—â—ë —Ä–∞–∑ –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ—ë –≤ –±—Ä–∞—É–∑–µ—Ä');
                
                // –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
                
            }, 1000);
        }
        
        function showLoading(text) {
            loadingText.textContent = text;
            loadingView.style.display = 'flex';
            downloadButton.disabled = true;
        }
        
        function hideLoading() {
            loadingView.style.display = 'none';
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ Telegram
        tg.BackButton.onClick(() => {
            tg.close();
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
        tg.BackButton.show();
        
    </script>
</body>
</html>
